---
title: "Wilcoxon Project"
author: "Emmanuel Asante"
date: "10/25/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(tidyverse)
library(rsample)
set.seed(785363)
```


## Issue 1

Generate samples from Poisson distribution. I will take a sample from Poisson distributions of two different rates and conduct a test of hypothesis on the two samples. Do this for 1000 simulated pairs of samples.

```{r, warning=F, message=F}

# Generate two poisson samples whose sizes are not necessarily the same
sample_1 <- rpois(10 + rbinom(1, size = 20, prob = 0.5), lambda = 10)
sample_2 <- rpois(10 + rbinom(1, size = 20, prob = 0.5), lambda = 10)

#Test the hypothesis that they both have the same mean(come from the same distribution)
wilcox.test(sample_1, sample_2)


# Create a dataframe to contain all the samples and computed values
wilcox_table <- data_frame(index = 1:1000)

# set number of simulations to 1000
n_sim <- 1000

wilcox_table <- wilcox_table %>% 
  mutate(sample_1 = rerun(n_sim, rpois(30 + rbinom(1, size = 20, prob = 0.5), lambda = 10)),
         sample_2 = rerun(n_sim, rpois(30 + rbinom(1, size = 20, prob = 0.5), lambda = 10)),
         wilcox_pvalue = flatten_dbl(map2(sample_1, sample_2, ~wilcox.test(.x, .y, exact = FALSE)$p.value)))

# Type 1 error rate of the test on the samples of the same poisson population

mean(wilcox_table$wilcox_pvalue<=0.05)

```

Add a column to indicate that the Null Hypothesis is rejected or not

```{r}
wilcox_table <- wilcox_table %>% 
  mutate(Reject = ifelse(wilcox_pvalue <= 0.05, 1, 0))
```


Can I put all of that into a function so that I can simulate 10000 of such dataframes and get the type 1 error rates? Then I will plot the histogram for the type 1 error rate(hopefully it follows some distribution?)

First lets try to make the function

```{r}
# set number of simulations to 1000
n_sim <- 1000

wilcox_table <- wilcox_table %>% 
  mutate(sample_1 = rerun(n_sim, rpois(30 + rbinom(1, size = 20, prob = 0.5), lambda = 10)),
         sample_2 = rerun(n_sim, rpois(30 + rbinom(1, size = 20, prob = 0.5), lambda = 10)),
         wilcox_pvalue = flatten_dbl(map2(sample_1, sample_2, ~wilcox.test(.x, .y, exact = F)$p.value)))


# Write a function for One table
# Did Charlotte say that we need a separate file for each function?

wilcox_one_table <- function(table_length = 1000, sample_from = rpois, ..., alpha = 0.05){
  wilcox_table <- data_frame(index = 1:table_length)
  wilcox_table <- wilcox_table %>% 
  mutate(sample_1 = rerun(table_length, sample_from(30 + rbinom(1, size = 20, prob = 0.5), ...)),
         sample_2 = rerun(table_length, sample_from(30 + rbinom(1, size = 20, prob = 0.5), ...)),
         wilcox_pvalue = flatten_dbl(map2(sample_1, sample_2, ~wilcox.test(.x, .y, exact = FALSE, conf.level = 1 - alpha)$p.value)), 
         Reject = ifelse(wilcox_pvalue <= alpha, TRUE, FALSE))
  #output <- list(type_1_error_rate = mean(wilcox_table$Reject), one_table = wilcox_table)
  output <- list(reject_rate = mean(wilcox_table$Reject), table = wilcox_table)
  # Output is the rejection rate
  # Invisible function prevents the output from showing
  invisible(output)
}


## Example using the wilcox_one_table function
aa <- wilcox_one_table(table_length = 1000, sample_from = rpois, alpha = 0.05, lambda = 20)

```


Write function to do several more of wilcox_one_table

```{r}
##### Write function to do several more of wilcox_one_table

# Probably use append
rates <- flatten_dbl(rerun(10, wilcox_one_table(table_length = 1000, sample_from = rpois, alpha = 0.05, lambda = 20)))
mean.default(rates)

# Put the above into a function

type_one_error <- function(n_sims = 100, table_length = 100){
  means_vector <- NULL
  for(i in 1:n_sims){
    rates = flatten_dbl(rerun(10, wilcox_one_table(table_length = table_length, sample_from = rpois, alpha = 0.05, lambda = 20)))
    table_rate = mean.default(rates)
    # Append the latest mean rate
    means_vector = append(means_vector, table_rate)
  }
 output = list(means_vector = means_vector)
 print(output)
}

# Or Use rerun() to generate even more
# wilcox_error_rate <- function(number_tables = 1000, distribution = rpois, ...){
#   
# }

```

Here I will edit the wilcox_one_table function to take a naive rate as an argument. Then I will use `map2` function to find the rejection rate and the
average absolute difference of the sample sizes in each test(row) of the wilcox table. Then I will make a plot of average difference in sample size on the x-axis, lambda as the y-axis and the rejection rate as the third dimension.Before the plot I ill put those variables in a dataframe and then use it as the ggplot input dataset.


```{r}

```

